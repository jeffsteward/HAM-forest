<script>
    let socket = io('/controller');

    let currentObjectIndex = 0;

    let annotationSVG;

    const objects = ['https://iiif.harvardartmuseums.org/manifests/object/6772',
                        'https://iiif.harvardartmuseums.org/manifests/object/256363',
                        'https://iiif.harvardartmuseums.org/manifests/object/196997',
                        'https://iiif.harvardartmuseums.org/manifests/object/312569',
                        'https://iiif.harvardartmuseums.org/manifests/object/303397',
                        'https://iiif.harvardartmuseums.org/manifests/object/95035',
                        'https://iiif.harvardartmuseums.org/manifests/object/320567'];

    const leafs = ["https://ids.lib.harvard.edu/ids/iiif/423290977/445,946,105,66/full/0/default.jpg",
                    "https://ids.lib.harvard.edu/ids/iiif/423290977/1090,2302,112,191/full/0/default.jpg",
                    "https://ids.lib.harvard.edu/ids/iiif/43182690/476,668,162,141/full/0/default.jpg"];

    const branches = ["https://ids.lib.harvard.edu/ids/iiif/423290977/802,2165,46,254/full/0/default.jpg",
                        "https://ids.lib.harvard.edu/ids/iiif/423290977/1261,315,59,486/full/0/default.jpg",
                        "https://ids.lib.harvard.edu/ids/iiif/43182690/433,1487,46,243/full/0/default.jpg",
                        "https://ids.lib.harvard.edu/ids/iiif/10466656/2043,344,105,580/full/0/default.jpg"];

    function spawn() {
        let data = {
            'leaf': leafs[Math.floor(Math.random() * Math.floor(4))],
            'branch': branches[Math.floor(Math.random() * Math.floor(5))]
        };
        socket.emit('create-tree', data);
    }

    function getSelectedRegions() {
        //d3.select("#leaf").node().getBBox()
    }

    function next() {
        currentObjectIndex +=1;
        if (currentObjectIndex >= objects.length) {
            currentObjectIndex = 0;
        }
        showImage(objects[currentObjectIndex]);
    }

    function previous() {
        currentObjectIndex -=1;
        if (currentObjectIndex < 0) {
            currentObjectIndex = objects.length - 1;
        }
        showImage(objects[currentObjectIndex]);
    }

    function showImage(manifest) {
        manifesto.loadManifest(manifest).then((manifest) => {
            let m = manifesto.create(manifest);
            let s = m.getSequences()[0];
            let c = s.getCanvasByIndex(0);
            let i = c.getImages()[0];

            imageInfoUri = i.getResource().getServices()[0].getInfoUri();
            imageID = i.getResource().getServices()[0].getProperty('@id');
            
            let imageURL = imageID + '/full/!500,500/0/default.jpg';
            let targetImage = $('#target')
                                .attr('src',imageURL)
                                .on('load', initializeAnnotations);
        });
    }

    function initializeAnnotations() {
        let targetImage = $('#target');
        annotationSVG.selectAll('*').remove();

        annotationSVG.attr('width', targetImage.width())
                       .attr('height', targetImage.height())
                       .style('top', targetImage.position().top)
                       .style('left', targetImage.position().left);

        annotationSVG.append('rect')
                        .attr('stroke', 'green')
                        .attr('stroke-width', 5)
                        .attr('fill', 'none')
                        .attr('x', 100)
                        .attr('y', 100)
                        .attr('width', 50)
                        .attr('height', 50)
                        .attr('id', 'leaf');

        annotationSVG.append('rect')
                        .attr('stroke', 'brown')
                        .attr('stroke-width', 5)
                        .attr('fill', 'none')
                        .attr('x', 300)
                        .attr('y', 175)
                        .attr('width', 25)
                        .attr('height', 150)
                        .attr('id', 'branch');
    }

    $(document).ready(() => {
        showImage(objects[currentObjectIndex]);

        annotationSVG = d3.select('#editor')
                            .append('svg')
                            .attr('id', 'annotations');
    });
</script>

<h1>{{title}}</h1>

<section id='editor'>
    <img src='' id='target'>
</section>    

<section id='controls'>
    <button onclick='spawn()'>Spawn</button>
    <button onclick='previous()'>Previous</button>
    <button onclick='next()'>Next</button>
</section>